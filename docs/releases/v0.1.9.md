# SSH Tunnel Manager - v0.1.9 Release

**Release Date**: 2025-12-31
**Status**: Production Ready with Remote Daemon Support

## Overview

This release focuses on remote daemon support and user experience improvements. The major additions enable SSH Tunnel Manager to work with remote daemons over HTTPS while maintaining security best practices - SSH private keys remain on the daemon filesystem and are never transmitted over the network.

Additionally, this release introduces user preference controls for recurring dialogs, improved daemon settings UI for remote scenarios, and enhanced error messages with accurate path information.

## What's New in v0.1.9

### âœ… Remote Daemon Profile Support

The application now fully supports connecting to remote daemons via HTTP/HTTPS while maintaining security.

**Key Features:**
- **Hybrid Profile Mode**: Profile content is sent via API, but SSH keys remain on daemon filesystem
- **`ProfileSourceMode` Enum**: Three modes defined:
  - `Local`: Traditional filesystem-based profile loading (unix-socket daemon)
  - `Hybrid`: Profile data sent via API + SSH keys on daemon filesystem (HTTP/HTTPS daemon)
  - `Remote`: Future enhancement for fully remote profiles
- **`StartTunnelRequest` Type**: New API request structure containing complete profile data
- **Security-First Design**: SSH private keys stay on daemon at `~/.ssh/` - never sent over network

**Technical Implementation:**
- Enhanced `/api/tunnels/start` endpoint accepts profile data in request body
- Daemon determines profile source mode based on connection type
- GUI/CLI automatically use hybrid mode when connecting to HTTP/HTTPS daemons

**Files Modified:**
- `crates/common/src/types.rs` - Added `ProfileSourceMode` enum and `StartTunnelRequest` struct
- `crates/daemon/src/api.rs` - Updated start endpoint to accept profile data
- `crates/daemon/src/tunnel.rs` - Profile source mode detection and handling
- `crates/gui-core/src/daemon/client.rs` - Hybrid mode profile transmission

### âœ… Enhanced SSH Key Error Messages

Error messages now show accurate paths based on daemon's actual environment instead of generic placeholders.

**Improvements:**
- **Daemon SSH Directory Reporting**: New `ssh_key_dir` field in `DaemonInfo` API response
- **Accurate Path Display**: Error messages show daemon's actual `~/.ssh` path (e.g., `/home/daemon/.ssh/`)
- **Simplified Instructions**: Removed specific `scp`/`chmod` commands - users know their setup best
- **SSH Agent Recommendation**: Added suggestion to use `ssh-agent` for encrypted keys
- **Relative Path Expansion**: Daemon expands `~/.ssh/id_rsa` to full path automatically

**User Experience:**
```
Before: "SSH key not found: ~/.ssh/id_rsa"
After:  "SSH key not found: /home/daemon/.ssh/id_rsa

         On the daemon host, ensure the key exists and has correct permissions (0600)."
```

**Files Modified:**
- `crates/common/src/types.rs` - Added `ssh_key_dir` to `DaemonInfo`
- `crates/daemon/src/api.rs` - Calculate and return actual SSH directory
- `crates/daemon/src/tunnel.rs` - Expand relative paths, improved error messages
- `crates/gui-core/src/daemon/client.rs` - Updated SSH key warning with daemon paths

### âœ… SSH Key Setup Warning Opt-Out

Users can now suppress the SSH key setup warning dialog for remote daemons.

**Features:**
- **"Don't show this again" Checkbox**: Added to SSH key setup warning dialog
- **Persistent Preference**: Stored in `~/.config/ssh-tunnel-manager/cli.toml`
- **Config Field**: New `skip_ssh_setup_warning: bool` in `DaemonClientConfig`
- **Backward Compatible**: Defaults to `false` using `#[serde(default)]`

**User Workflow:**
1. User connects to remote daemon with SSH key authentication
2. Warning dialog appears explaining SSH key must be on daemon filesystem
3. User checks "Don't show this message again"
4. Preference saved immediately to `cli.toml`
5. Future tunnel starts skip the warning automatically

**Files Modified:**
- `crates/common/src/daemon_client.rs` - Added `skip_ssh_setup_warning` field
- `crates/gui-core/src/daemon/client.rs` - Check preference before showing warning
- `crates/gui-core/src/daemon/config.rs` - Added `save_skip_ssh_warning_preference()`
- `crates/gui-gtk/src/ui/details.rs` - Added checkbox to warning dialog
- `crates/gui-gtk/src/ui/profile_details.rs` - Added checkbox to warning dialog

### âœ… Daemon Settings UI Improvements

Better UI for remote daemon scenarios - hides local-only operations.

**Changes:**
- **Conditional Restart Button**: "Restart Daemon" row only shown for unix-socket mode
- **Prevents Confusion**: Remote HTTPS daemons can't be restarted via API by design
- **Cleaner Interface**: Less clutter when managing remote daemons

**Files Modified:**
- `crates/gui-gtk/src/ui/daemon_settings.rs` - Hide restart row for HTTPS mode

### âœ… Debug Logging Migration

All debug output now uses the `tracing` framework for structured logging.

**Improvements:**
- **Consistent Logging**: Converted all `eprintln!` calls to `tracing::debug!` and `tracing::warn!`
- **Better Diagnostics**: Structured log output with module information
- **Configurable Levels**: Can be controlled via `RUST_LOG` environment variable

**Example:**
```bash
# Before
eprintln!("Event received: {:?}", event);

# After
tracing::debug!("Event received: {:?}", event);
```

**Files Modified:**
- `crates/gui-gtk/src/ui/event_handler.rs` - All debug statements
- `crates/gui-core/src/daemon/sse.rs` - SSE parsing and event delivery
- Multiple other GUI files with debug output

## What Still Works (From v0.1.8)

All features from v0.1.8 continue to work as before:

### âœ… Core Functionality

**SSH Tunnel Management**
- âœ… Local port forwarding (`ssh -L`) fully implemented
- âœ… Interactive authentication (password, SSH key passphrase, keyboard-interactive/2FA)
- âœ… SSH host key verification with OpenSSH-compatible known_hosts
- âœ… Real-time connection status via Server-Sent Events (SSE)
- âœ… Profile-based configuration with TOML persistence
- âœ… System keyring integration for credential storage

**Daemon**
- âœ… Three operational modes: Unix socket (default), TCP HTTP (localhost), TCP HTTPS (network)
- âœ… Token-based authentication (enabled by default)
- âœ… Self-signed TLS certificate generation with fingerprint pinning
- âœ… Graceful shutdown with proper cleanup
- âœ… PID file locking prevents duplicate instances
- âœ… REST API and SSE endpoint for tunnel control

**CLI**
- âœ… Profile management (add, list, show, delete, info)
- âœ… Tunnel control (start, stop, restart, status)
- âœ… Batch operations (stop --all, status --all)
- âœ… Interactive prompts and non-interactive flags
- âœ… Proactive config validation with helpful error messages
- âœ… Color-coded output and formatted tables

**GUI**
- âœ… Modern Libadwaita/GTK4 interface
- âœ… Two-page navigation (Client profiles and Daemon status)
- âœ… Full profile CRUD (create, edit, delete)
- âœ… Real-time status indicators (colored dots: green/orange/red/gray)
- âœ… Daemon connection monitoring with auto-reconnect
- âœ… Authentication dialogs for interactive prompts
- âœ… Help and About dialogs with markdown rendering

## Known Limitations & Missing Features

### âŒ Not Yet Implemented

**Tunnel Types**
- âŒ Remote port forwarding (`ssh -R`) - Planned for future release
- âŒ Dynamic/SOCKS proxy (`ssh -D`) - Planned for future release
- âŒ Auto-reconnect/health monitoring - Config exists but not wired

**GUI Features**
- âŒ System tray integration
- âŒ Desktop notifications
- âŒ Profile autostart configuration

**Authentication**
- âŒ Remote host password storage - Only SSH key passphrase is stored
  - Keyboard-interactive and password auth require manual entry each time

## Known Issues

### ðŸ”§ Minor Issues

**GUI**
- The Client navigation link changes color when navigating between pages

**Testing**
- âš ï¸ Tests in `crates/common` are outdated due to schema drift

**Edge Cases**
- âš ï¸ 60-second timeout when canceling tunnel during auth phase with no GUI client connected

## Installation

**Debian Packages (Recommended)**

Three separate .deb packages are available for Ubuntu/Debian systems:

```bash
# Download packages from releases:
# - ssh-tunnel-daemon_0.1.9-1_amd64.deb
# - ssh-tunnel-cli_0.1.9-1_amd64.deb
# - ssh-tunnel-gui-gtk_0.1.9-1_amd64.deb

# Install all components:
sudo dpkg -i ssh-tunnel-daemon_*.deb ssh-tunnel-cli_*.deb ssh-tunnel-gui-gtk_*.deb
sudo apt-get install -f  # Install dependencies if needed
```

**From Source**

```bash
git clone https://github.com/SchirmForge/ssh-tunnel
cd ssh-tunnel
git checkout v0.1.9
cargo build --release --workspace --exclude ssh-tunnel-gui-qt
```

Binaries will be in `target/release/`:
- `ssh-tunnel-daemon`
- `ssh-tunnel` (CLI)
- `ssh-tunnel-gtk` (GUI)

## Upgrade Notes

### Upgrading from v0.1.8

**Configuration Changes:**
- New field in `cli.toml`: `skip_ssh_setup_warning = false` (optional, auto-added)
- No breaking changes to existing configuration files
- All v0.1.8 profiles and settings work without modification

**API Changes:**
- New API field: `DaemonInfo.ssh_key_dir` (non-breaking addition)
- Enhanced `/api/tunnels/start` endpoint accepts optional profile data in request body
- Existing API clients continue to work (backward compatible)

**Behavioral Changes:**
- SSH key error messages now show daemon-side paths (more accurate)
- Restart daemon button hidden for HTTPS connections (UI improvement)
- Debug output uses `tracing` instead of `eprintln` (no user impact)

## Quick Start

### Local Daemon (Unix Socket)

```bash
# Start the daemon
ssh-tunnel-daemon &

# Or with systemd
systemctl start --user ssh-tunnel-daemon

# Create a profile
ssh-tunnel add myserver \
  --host example.com \
  --user myuser \
  --key ~/.ssh/id_ed25519 \
  --local-port 8080 \
  --remote-host localhost \
  --remote-port 80

# Start the tunnel
ssh-tunnel start myserver
```

### Remote Daemon (HTTPS)

**On the daemon host:**
```bash
# Configure daemon for HTTPS
cat > ~/.config/ssh-tunnel-manager/daemon.toml <<EOF
listener_mode = "tcp-https"
bind_host = "0.0.0.0"
bind_port = 3443
require_auth = true
EOF

# Start daemon
ssh-tunnel-daemon
```

**On your local machine:**
```bash
# Copy the daemon config snippet
scp daemon-host:.config/ssh-tunnel-manager/cli-config.snippet \
    ~/.config/ssh-tunnel-manager/cli.toml

# Or configure manually
cat > ~/.config/ssh-tunnel-manager/cli.toml <<EOF
daemon_mode = "tcp-https"
daemon_host = "daemon-hostname"
daemon_port = 3443
auth_token = "YOUR_TOKEN_HERE"
tls_fingerprint = "FINGERPRINT_HERE"
EOF

# Ensure SSH keys exist on daemon host
ssh daemon-host "ls -la ~/.ssh/"

# Create profile (will use hybrid mode automatically)
ssh-tunnel add myserver \
  --host example.com \
  --user myuser \
  --key ~/.ssh/id_ed25519 \
  --local-port 8080 \
  --remote-host localhost \
  --remote-port 80

# Start tunnel (SSH key must be on daemon host)
ssh-tunnel start myserver
```

## Security Considerations

### Remote Daemon Best Practices

âœ… **Always use HTTPS for network access** - HTTP mode is restricted to loopback
âœ… **Keep auth tokens secure** - Use 0600 permissions on `cli.toml`
âœ… **Use TLS fingerprint pinning** - Prevents MITM attacks
âœ… **SSH keys stay on daemon** - Never transmitted over network in hybrid mode

### SSH Key Management for Remote Daemons

When using remote daemons:
1. **Copy SSH keys to daemon host** before creating profiles
2. **Set proper permissions**: `chmod 600 ~/.ssh/id_*` on daemon host
3. **Use ssh-agent** for encrypted keys (recommended)
4. **Test SSH connection** from daemon to target: `ssh -i ~/.ssh/id_rsa user@host`

## System Requirements

**Platform**
- Linux (x86_64, aarch64)
- systemd (optional, for service management)
- D-Bus session bus (for keyring access)

**Runtime Dependencies**
- GTK4 â‰¥ 4.10
- libadwaita â‰¥ 1.4
- Secret Service API provider (gnome-keyring, KDE Wallet, or compatible)
- OpenSSH-compatible SSH server (remote)
- **No OpenSSL required** - Uses pure Rust TLS implementation (rustls)

**Build Dependencies**
- Rust â‰¥ 1.75
- cargo
- GTK4 development libraries
- libadwaita development libraries
- pkg-config

## Troubleshooting

### SSH key errors with remote daemon

**Symptom**: "SSH key not found: /home/daemon/.ssh/id_rsa"

**Solution**:
```bash
# On daemon host, verify key exists
ls -la ~/.ssh/id_rsa

# Check permissions (must be 0600)
chmod 600 ~/.ssh/id_rsa

# Test SSH connection from daemon to target
ssh -i ~/.ssh/id_rsa user@target-host
```

### "Don't show this again" checkbox not working

**Symptom**: Warning dialog keeps appearing despite checking the box

**Solution**:
```bash
# Check if preference was saved
grep skip_ssh_setup_warning ~/.config/ssh-tunnel-manager/cli.toml

# If missing, add manually
echo 'skip_ssh_setup_warning = true' >> ~/.config/ssh-tunnel-manager/cli.toml

# Restart GUI
```

### Restart daemon button missing

**Symptom**: Can't find restart daemon button in GUI

**Explanation**: This is intentional behavior for HTTPS mode. The restart button only appears for unix-socket connections where the daemon is local. Remote daemons over HTTPS must be restarted on the daemon host directly.

## Contributing

Contributions welcome for:
- Documentation improvements
- Bug fixes and testing
- Feature suggestions

## License

Apache-2.0

## Credits

Developed with assistance from Generative AI.

---

**Full Changelog**: See [CHANGELOG.md](../../CHANGELOG.md) for detailed version history.

**Project Status**: See [docs/PROJECT_STATUS.md](../PROJECT_STATUS.md) for roadmap and implementation details.
