# Release Notes - v0.1.10

**Release Date**: 2026-01-02

## Overview

Version 0.1.10 focuses on reliability improvements, bug fixes, and architecture refinements. This release fixes critical authentication retry issues, eliminates language-dependent error detection, consolidates the SSE client, and improves daemon logging.

## Key Highlights

### üêõ Fixed: Authentication Retry on Failed 2FA

**Problem**: First failed 2FA attempt would permanently fail the tunnel connection, even when the SSH server allowed retries.

**Solution**:
- **Daemon**: Now properly checks if `keyboard-interactive` is still in server's `remaining_methods`
- **Daemon**: Starts new keyboard-interactive session if server permits retry
- **Daemon**: Respects server's retry policy (typically 3 attempts for Google Authenticator)
- **GUI**: SSE-driven dialog state eliminates race conditions
- **GUI**: Dialog stays open showing "Verifying..." until SSE confirms next state
- **Result**: Users can retry 2FA codes until server accepts or permanently rejects

### üåç Fixed: Language-Independent Error Detection

**Problem**: Daemon used string matching on error messages, which would fail on non-English systems or when connecting to non-English SSH servers.

**Solution**:
- **Hyper errors**: Uses type-based error inspection (`is_timeout()`, `is_parse()`, `is_body_write_aborted()`, etc.)
- **Encrypted key detection**: Uses `russh::keys::Error::KeyIsEncrypted` enum variant
- **IO errors**: Checks `ErrorKind` enum variants (`ConnectionReset`, `BrokenPipe`, `TimedOut`, etc.)
- **Keyboard-interactive**: Server's prompt text passed as-is (supports non-English SSH servers)
- **Result**: Daemon works correctly regardless of system locale or SSH server language

### üîß Changed: SSE Client Consolidation

**Problem**: `EventListener` and `TunnelEvent` were duplicated between gui-core and common crates.

**Solution**:
- Moved SSE client from `gui-core/src/daemon/sse.rs` to `common/src/sse.rs`
- Both CLI and GUI now import from `ssh_tunnel_common::sse`
- Removed duplicate `TunnelEvent` enum from `daemon_client.rs`
- Renamed domain event type to `TunnelDomainEvent` to avoid conflict
- **Result**: Single source of truth for SSE client, shared by all frontends

### üìä Changed: Improved Daemon Logging

**Problem**: SSE stream disconnects logged as ERROR, cluttering logs with normal client behavior.

**Solution**:
- Intelligent error categorization: ClientDisconnect, SseStreamClose, NetworkError, ProtocolError, ServerError
- SSE stream disconnects moved to DEBUG level
- Structured logging with error source, type, and actionable hints
- HTTP request tracing middleware added (path, method, status, latency)
- **Result**: Cleaner logs, easier debugging, better diagnostics

## Technical Details

### Error Detection Methods

**Hyper error inspection**:
- `is_timeout()` - Detects timeout errors
- `is_parse()`, `is_parse_too_large()`, `is_parse_status()` - Protocol errors
- `is_body_write_aborted()` - SSE client disconnected
- `is_incomplete_message()` - Connection closed mid-message
- `is_closed()`, `is_canceled()` - Normal disconnects

**IO error kind matching**:
- `ConnectionReset`, `ConnectionAborted` - Client disconnect
- `BrokenPipe`, `NotConnected` - Connection issues
- `TimedOut` - Network timeout

### Authentication Flow

**Keyboard-interactive retry**:
1. User submits auth response
2. Daemon sends to SSH server
3. Server responds with success or new challenge
4. Daemon checks if `keyboard-interactive` in `remaining_methods`
5. If yes, starts new session; if no, fails permanently
6. GUI waits for SSE event before updating dialog

### SSE Architecture

**Module locations**:
- `crates/common/src/sse.rs` - EventListener and TunnelEvent (new)
- `crates/gui-core/src/daemon/mod.rs` - Re-exports from common
- `crates/cli/src/main.rs` - Imports from common

**Event types**:
- `TunnelEvent` - SSE wire protocol (in common/sse.rs)
- `TunnelDomainEvent` - Business logic events (in common/types.rs)

## Upgrade Notes

### For Users

**No breaking changes** - This is a patch release with bug fixes and improvements. All existing profiles, configurations, and workflows remain unchanged.

**Recommended actions**:
1. Update packages: `sudo apt update && sudo apt upgrade` (Debian/Ubuntu)
2. Restart daemon: `systemctl --user restart ssh-tunnel-daemon`
3. Test authentication retry with 2FA tunnels

### For Developers

**Code changes required if you**:
- Import `EventListener` or `TunnelEvent` - now in `ssh_tunnel_common::sse`
- Use `TunnelEvent` from `types.rs` - renamed to `TunnelDomainEvent`

**Example migration**:
```rust
// Old (v0.1.9)
use ssh_tunnel_common::daemon_client::TunnelEvent;

// New (v0.1.10)
use ssh_tunnel_common::sse::TunnelEvent;
use ssh_tunnel_common::TunnelDomainEvent; // If you need domain events
```

## Files Changed

### Daemon
- `crates/daemon/src/main.rs` - Type-based error categorization
- `crates/daemon/src/api.rs` - Centralized error detection, tracing middleware
- `crates/daemon/src/tunnel.rs` - Auth retry loop, encrypted key detection, keyboard-interactive handling

### Common
- `crates/common/src/sse.rs` - NEW: EventListener and TunnelEvent moved here
- `crates/common/src/daemon_client.rs` - Removed duplicate TunnelEvent
- `crates/common/src/types.rs` - Renamed TunnelEvent to TunnelDomainEvent
- `crates/common/src/lib.rs` - Updated exports

### GUI
- `crates/gui-core/src/daemon/mod.rs` - Re-exports SSE from common
- `crates/gui-core/src/daemon/sse.rs` - DELETED (moved to common)
- `crates/gui-gtk/src/ui/auth_dialog.rs` - SSE-driven dialog state
- `crates/gui-gtk/src/ui/event_handler.rs` - Updated event handling

### CLI
- `crates/cli/src/main.rs` - Updated SSE imports

### Documentation
- `crates/gui-core/assets/about.md` - Updated content
- `crates/gui-core/assets/help.md` - Updated content
- `CHANGELOG.md` - v0.1.10 release notes
- `docs/PROJECT_STATUS.md` - Updated to v0.1.10
- `README.md` - Updated version

## Known Issues

No new issues introduced in this release. See [KNOWN_ISSUES.md](../KNOWN_ISSUES.md) for existing limitations.

## Contributors

This release was developed by the SSH Tunnel Manager Contributors.

## What's Next

**Planned for v0.2.x**:
- GUI notification system for tunnel events
- Adaptive authentication dialogs with dynamic sizing
- User manual with screenshots and examples
- Remote port forwarding (`ssh -R`)
- Dynamic/SOCKS proxy (`ssh -D`)

See [PROJECT_STATUS.md](../PROJECT_STATUS.md) for the complete roadmap.

---

**Full Changelog**: https://github.com/SchirmForge/ssh-tunnel-manager/blob/master/CHANGELOG.md
